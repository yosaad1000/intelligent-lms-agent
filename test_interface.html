<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Chat Test Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .section h2 {
            color: #555;
            margin-top: 0;
        }
        
        .file-upload {
            background-color: #f8f9fa;
        }
        
        .chat-section {
            background-color: #fff;
        }
        
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            resize: vertical;
        }
        
        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .chat-history {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            background-color: #fafafa;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        
        .message.user {
            background-color: #e3f2fd;
            text-align: right;
        }
        
        .message.assistant {
            background-color: #f1f8e9;
        }
        
        .message-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .citations {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .api-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .api-status.online {
            background-color: #28a745;
            color: white;
        }
        
        .api-status.offline {
            background-color: #dc3545;
            color: white;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #666;
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="api-status" id="apiStatus">Checking...</div>
    
    <div class="container">
        <h1>ü§ñ RAG-Enhanced Chat Test Interface</h1>
        
        <!-- File Upload Section -->
        <div class="section file-upload">
            <h2>üìÅ Upload Document</h2>
            <p>Upload a text file to add to your knowledge base for RAG chat.</p>
            
            <input type="text" id="filename" placeholder="Enter filename (e.g., ml-basics.txt)" value="test-document.txt">
            
            <textarea id="fileContent" rows="8" placeholder="Paste your document content here or use the file picker below...">Machine Learning Fundamentals

Machine learning is a subset of artificial intelligence (AI) that enables computers to learn and improve from experience without being explicitly programmed. It focuses on the development of computer programs that can access data and use it to learn for themselves.

Types of Machine Learning:

1. Supervised Learning: Uses labeled training data to learn a mapping function from input variables to output variables. Examples include classification and regression problems.

2. Unsupervised Learning: Finds hidden patterns in data without labeled examples. Common techniques include clustering and dimensionality reduction.

3. Reinforcement Learning: An agent learns to make decisions by taking actions in an environment to maximize cumulative reward.

Key Concepts:
- Training Data: The dataset used to teach the machine learning algorithm
- Features: Individual measurable properties of observed phenomena
- Model: The mathematical representation of a real-world process
- Algorithm: The method used to build the model

Applications:
Machine learning is used in various fields including image recognition, natural language processing, recommendation systems, autonomous vehicles, medical diagnosis, and financial fraud detection.</textarea>
            
            <input type="file" id="fileInput" accept=".txt,.md,.pdf" style="margin-top: 10px;">
            
            <button onclick="uploadFile()" id="uploadBtn">üì§ Upload Document</button>
            
            <div id="uploadStatus"></div>
        </div>
        
        <!-- Chat Section -->
        <div class="section chat-section">
            <h2>üí¨ RAG Chat</h2>
            <p>Ask questions about your uploaded documents. The AI will use RAG to provide contextual answers.</p>
            
            <div class="chat-history" id="chatHistory">
                <div class="message assistant">
                    <div class="message-meta">Assistant</div>
                    <div>Hello! I'm your RAG-enhanced AI assistant. Upload a document above and then ask me questions about it. I'll use the content to provide accurate, contextual answers.</div>
                </div>
            </div>
            
            <textarea id="chatInput" rows="3" placeholder="Ask a question about your uploaded documents...">What is machine learning according to my document?</textarea>
            
            <button onclick="sendMessage()" id="chatBtn">üöÄ Send Message</button>
            
            <div class="loading" id="chatLoading">
                <div class="spinner"></div>
                Processing your message...
            </div>
            
            <div id="chatStatus"></div>
        </div>
        
        <!-- API Test Section -->
        <div class="section">
            <h2>üîß API Test</h2>
            <button onclick="testHealthEndpoint()">üè• Test Health Endpoint</button>
            <button onclick="testChatHistory()">üìú Get Chat History</button>
            <button onclick="clearChat()">üóëÔ∏è Clear Chat</button>
            
            <div id="apiTestStatus"></div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://1iaj32i7cd.execute-api.us-east-1.amazonaws.com/prod';
        const USER_ID = 'test-user-' + Math.random().toString(36).substr(2, 9);
        
        // Check API status on load
        window.onload = function() {
            checkApiStatus();
        };
        
        async function checkApiStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const data = await response.json();
                
                if (response.ok && data.status === 'healthy') {
                    document.getElementById('apiStatus').textContent = 'üü¢ API Online';
                    document.getElementById('apiStatus').className = 'api-status online';
                } else {
                    throw new Error('API not healthy');
                }
            } catch (error) {
                document.getElementById('apiStatus').textContent = 'üî¥ API Offline';
                document.getElementById('apiStatus').className = 'api-status offline';
            }
        }
        
        async function uploadFile() {
            const filename = document.getElementById('filename').value;
            const content = document.getElementById('fileContent').value;
            const uploadBtn = document.getElementById('uploadBtn');
            const statusDiv = document.getElementById('uploadStatus');
            
            if (!filename || !content) {
                showStatus(statusDiv, 'Please provide both filename and content', 'error');
                return;
            }
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ Uploading...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/files`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: USER_ID,
                        filename: filename,
                        content: content,
                        subject_id: 'test-subject'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus(statusDiv, `‚úÖ File uploaded successfully! File ID: ${data.file_id || 'Unknown'}`, 'success');
                    
                    // Add a message to chat
                    addMessageToChat('system', `üìÅ Document "${filename}" uploaded and processed for RAG.`);
                } else {
                    showStatus(statusDiv, `‚ùå Upload failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus(statusDiv, `‚ùå Upload error: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üì§ Upload Document';
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            const chatBtn = document.getElementById('chatBtn');
            const loading = document.getElementById('chatLoading');
            const statusDiv = document.getElementById('chatStatus');
            
            if (!message) {
                showStatus(statusDiv, 'Please enter a message', 'error');
                return;
            }
            
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Clear input and show loading
            input.value = '';
            chatBtn.disabled = true;
            loading.style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: USER_ID,
                        message: message,
                        subject_id: 'test-subject'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Add assistant response to chat
                    const citations = data.citations && data.citations.length > 0 
                        ? `\n\nüìö Sources: ${data.citations.join(', ')}` 
                        : '';
                    
                    const ragInfo = data.rag_enhanced 
                        ? `\n\nüîç RAG Enhanced: ${data.rag_documents_used} documents used`
                        : '\n\n‚ö†Ô∏è No RAG context (upload documents first)';
                    
                    addMessageToChat('assistant', data.response + citations + ragInfo);
                    
                    showStatus(statusDiv, `‚úÖ Response received (RAG: ${data.rag_enhanced})`, 'success');
                } else {
                    addMessageToChat('assistant', `‚ùå Error: ${data.error || 'Failed to get response'}`);
                    showStatus(statusDiv, `‚ùå Chat failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                addMessageToChat('assistant', `‚ùå Connection error: ${error.message}`);
                showStatus(statusDiv, `‚ùå Chat error: ${error.message}`, 'error');
            } finally {
                chatBtn.disabled = false;
                loading.style.display = 'none';
            }
        }
        
        function addMessageToChat(role, content) {
            const chatHistory = document.getElementById('chatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const timestamp = new Date().toLocaleTimeString();
            const roleLabel = role === 'user' ? 'You' : role === 'assistant' ? 'Assistant' : 'System';
            
            messageDiv.innerHTML = `
                <div class="message-meta">${roleLabel} - ${timestamp}</div>
                <div>${content}</div>
            `;
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        async function testHealthEndpoint() {
            const statusDiv = document.getElementById('apiTestStatus');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const data = await response.json();
                
                if (response.ok) {
                    showStatus(statusDiv, `‚úÖ Health Check: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showStatus(statusDiv, `‚ùå Health check failed: ${response.status}`, 'error');
                }
            } catch (error) {
                showStatus(statusDiv, `‚ùå Health test error: ${error.message}`, 'error');
            }
        }
        
        async function testChatHistory() {
            const statusDiv = document.getElementById('apiTestStatus');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/chat?user_id=${USER_ID}`);
                const data = await response.json();
                
                if (response.ok) {
                    const conversations = data.conversations || [];
                    showStatus(statusDiv, `‚úÖ Found ${conversations.length} conversations`, 'success');
                } else {
                    showStatus(statusDiv, `‚ùå History test failed: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(statusDiv, `‚ùå History test error: ${error.message}`, 'error');
            }
        }
        
        function clearChat() {
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.innerHTML = `
                <div class="message assistant">
                    <div class="message-meta">Assistant</div>
                    <div>Chat cleared. Upload a document and ask me questions about it!</div>
                </div>
            `;
        }
        
        function showStatus(element, message, type) {
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }
        
        // Handle file input
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('filename').value = file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('fileContent').value = e.target.result;
                };
                reader.readAsText(file);
            }
        });
        
        // Handle Enter key in chat input
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>